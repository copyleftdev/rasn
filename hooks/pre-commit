#!/usr/bin/env bash
set -e

echo "ðŸ” Running pre-commit checks..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print status
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} $2"
    else
        echo -e "${RED}âœ—${NC} $2"
        return 1
    fi
}

# 1. Check formatting
echo "â†’ Checking code formatting..."
cargo fmt --all -- --check
print_status $? "Format check"
echo ""

# 2. Run Clippy
echo "â†’ Running clippy..."
cargo clippy --all-features --workspace -- -D warnings
print_status $? "Clippy"
echo ""

# 3. Run tests
echo "â†’ Running tests..."
cargo test --all-features --workspace
print_status $? "Tests"
echo ""

# 4. Check build
echo "â†’ Building release..."
cargo build --release --bin rasn
print_status $? "Build"
echo ""

# 5. Check for TODO/FIXME in staged files
echo "â†’ Checking for TODO/FIXME..."
TODOS=$(git diff --cached --name-only | grep -E '\.(rs|toml)$' | xargs grep -n "TODO\|FIXME" 2>/dev/null || true)
if [ -n "$TODOS" ]; then
    echo -e "${YELLOW}âš ${NC} Found TODO/FIXME in staged files:"
    echo "$TODOS"
    echo ""
fi

echo -e "${GREEN}âœ“ All pre-commit checks passed!${NC}"
echo ""
